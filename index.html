<!DOCTYPE html>

<head>

  <meta charset="utf-8">

  <title>Choropleth map from GeoJSON</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css" integrity="sha512-M2wvCLH6DSRazYeZRIm1JnYyh22purTM+FDB5CsyxtQJYeKq83arPe5wgbNmcFXGqiSH2XR8dT/fJISVA1r/zQ==" crossorigin=""/>

  <script src="https://unpkg.com/leaflet@1.2.0/dist/leaflet.js" integrity="sha512-lInM/apFSqyy1o6s89K4iQUKg6ppXEgsVxT35HbzUupEVRh2Eu9Wdl4tHj7dZO0s1uvplcYGmt3498TtHq+log==" crossorigin=""></script>

  <style type="text/css">
    html, body {
      margin: 0;
      height: 100%;
    }

    h2 {
      margin: .5em;
    }

    /* Bildschirmfüllende Karte */
    #map {
      width: 100%;
      height: 100%;
    }

    /* Styles für die Legende */
    #map .legend {
      padding: 10px;
      border-radius: 5px;
      background: white;
    }

    #map .legend h3 {
      margin-top: 0;
    }

    #map .legend i {
      width: 18px;
      height: 18px;
      float: left;
      margin-right: 8px;
    }
  </style>
</head>

<body>

  <h2>Choroplethen-Karte mit Legende</h2>

  <!-- Container für Karte erstellen -->
  <div id="map"></div>

  <script>

    // Lade zuerst das GeoJSON, ...
    getJson('data/map.geojson', function (geojson) {
      // ... dann lade die Statistik-Daten für die Stadtbezirke, ...
      getJson('data/data.json', function (data) {
        // ... dann rufe die Funktion drawMap() mit beiden Datensätzen auf
        drawMap(geojson, data);
      });
    });

    function drawMap(geojson, data) {

      // Karte mit Mittelpunkt in München und Zoom-Level 11 erstellen
      var map = L.map('map').setView([48.13, 11.57], 11);

      // Basiskarte von OpenStreetMap hinzufügen
      L.tileLayer('https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>, Tiles courtesy of <a href="http://hot.openstreetmap.org/" target="_blank">Humanitarian OpenStreetMap Team</a>'
      }).addTo(map);

      // Flächen aus GeoJson erstellen
      L.geoJson(geojson, {
        style: function (feature) {
          return {
            // Farbwert basierend auf dem Wert für Ausländeranteil abrufen
            fillColor: getColor(
              getData(data, feature.properties.name)
            ),
            // Sonstiges Design
            fillOpacity: .8,
            color: 'white',
            opacity: 1,
            weight: 2
          };
        }
      }).addTo(map);

      // Legende unten rechts hinzufügen
      var legend = L.control({position: 'bottomright'});
      // Funktion, welche die Inhalte der Legende liefert festlegen
      legend.onAdd = getLegend;
      legend.addTo(map);
    }

    // 'Berg am Laim' => 31.6
    function getData(data, name) {
      var bereich = data.filter(function (d) {
        return d.name === name;
      });
      if (bereich.length > 0)
      {return bereich[0]['grid'];}
      else
      return 0;
    }

    // Farbskala-Funktion, welche jeweils für einen bestimmten
    // Wert eine Farbe zurückgibt: 31.6 => '#cbc9e2'
    function getColor(value) {
      var colors = ['white','#fff5f0','#fee0d2','#fcbba1','#fc9272','#fb6a4a','#ef3b2c','#cb181d','#a50f15','#67000d']
      switch (true) {
        case value <= 0:
          return colors[0];
          case value <= 0.1:
          return colors[1];
          case value <= 0.2:
          return colors[2];
          case value <= 0.3:
          return colors[3];
          case value <= 0.4:
          return colors[4];
          case value <= 0.5:
          return colors[5];
          case value <= 0.6:
          return colors[6];
          case value <= 0.7:
          return colors[7];
          case value <= 0.8:
          return colors[8]; 
           case value <= 0.9:
          return colors[9];
        default:
          return 'black';
      }
    }

    // HTML-Inhalt für die Legende generieren
    function getLegend() {

      // Leeres HTML-Element erstellen
      var div = L.DomUtil.create('div', 'info legend');

      // Schwellenwerte
      var grades = [0,0.1,0.2,0.3,0.4,0.5,0.6,0.7,0.8,0.9];

      // Überschrift hinzufügen
      div.innerHTML += '<h3>Grid cost exlcude mwst</h3>';

      // Erstelle für jeden Schwellenwert einen Eintrag mit
      // jeweiligen Farben
      for (var i = 0; i < grades.length; i++) {
        div.innerHTML +=
          '<i style="background:' + getColor(grades[i] + 1) + '"></i> ' +
          grades[i] + (grades[i + 1] ? ' % - ' + grades[i + 1] + ' %<br>' : ' % +');
      }

      return div;
    }

    // Generische Funktion um externe JSON-Dateien zu laden
    function getJson(path, callback) {
      var httpRequest = new XMLHttpRequest();

      httpRequest.overrideMimeType('application/json');
      httpRequest.onreadystatechange = function() {
        if (httpRequest.readyState === 4) {
          if (httpRequest.status === 200) {
            if (callback) callback(JSON.parse(httpRequest.responseText));
          }
        }
      };

      httpRequest.open('GET', path);
      httpRequest.send();
    }
  </script>
</body>
